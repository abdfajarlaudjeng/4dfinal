<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Validasi Data 4D - Berdasarkan Kepala dan Ekor</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6 font-sans max-w-5xl mx-auto">

  <h1 class="text-2xl font-bold mb-6 text-center">Validasi Data 4D (Sheet 4d)</h1>

  <div class="bg-white p-6 rounded-lg shadow mb-6 grid gap-6">
    <div>
      <label for="inputKepala" class="block font-medium mb-1">Input Kepala Main (max 7 digit tanpa spasi atau tanda lain)</label>
      <input type="text" id="inputKepala" maxlength="7" placeholder="Contoh: 1234567" class="w-full border rounded px-3 py-2" pattern="\d*" title="Hanya angka" />
    </div>
    <div>
      <label for="inputEkor" class="block font-medium mb-1">Input Ekor Main (max 7 digit tanpa spasi atau tanda lain)</label>
      <input type="text" id="inputEkor" maxlength="7" placeholder="Contoh: 7654321" class="w-full border rounded px-3 py-2" pattern="\d*" title="Hanya angka" />
    </div>
    <button id="btnValidasi" class="bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition-colors">Validasi</button>
  </div>

  <div id="loading" class="hidden text-blue-600 mb-4 text-center font-semibold">‚è≥ Memproses data...</div>

  <div id="result" class="overflow-x-auto bg-white p-4 rounded-lg shadow"></div>

  <script>
    const SHEET_ID = '1jQWs8CTzPzibBDQ-btIexLE70oMqdhIFZOrnZ8dbEUQ';
    const SHEET_NAME = '4d';
    const gvizUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&headers=1`;

    const inputKepala = document.getElementById('inputKepala');
    const inputEkor = document.getElementById('inputEkor');
    const btnValidasi = document.getElementById('btnValidasi');
    const loadingEl = document.getElementById('loading');
    const resultEl = document.getElementById('result');

    async function fetchSheet() {
      try {
        const res = await fetch(gvizUrl);
        const text = await res.text();
        const jsonText = text.replace(/^.*setResponse\(|\);\s*$/gs, '');
        const data = JSON.parse(jsonText).table;
        return data;
      } catch (err) {
        resultEl.innerHTML = `<p class="text-red-600 font-semibold text-center">Gagal memuat data: ${err.message}</p>`;
        loadingEl.classList.add('hidden');
        throw err;
      }
    }

    function filterData(table, kepalaInput, ekorInput) {
      const rows = table.rows.map(r => r.c.map(c => c && c.v !== null ? String(c.v) : ""));
      const headers = table.cols.map(c => c.label || '');

      // Jika kedua input kosong, tampilkan semua data
      if (!kepalaInput && !ekorInput) return { rows, headers };

      // Filter rows
      const filtered = rows.filter(r => {
        const num = r[0]; // Asumsi kolom pertama adalah angka 4D string

        if (!num || num.length < 4) return false;

        const kepala = num[2]; // digit ke-3 (index 2)
        const ekor = num[3];   // digit ke-4 (index 3)

        if (kepalaInput && !kepalaInput.includes(kepala)) return false;
        if (ekorInput && !ekorInput.includes(ekor)) return false;

        return true;
      });

      return { rows: filtered, headers };
    }

    function renderTable(headers, rows) {
      if (!rows.length) {
        resultEl.innerHTML = '<p class="text-center text-gray-600 font-semibold">Tidak ada data cocok.</p>';
        return;
      }

      let html = '<table class="table-auto border-collapse w-full">';
      html += '<thead><tr>';
      headers.forEach(h => {
        html += `<th class="border px-3 py-2 bg-gray-100 text-center">${h}</th>`;
      });
      html += '</tr></thead><tbody>';

      rows.forEach(r => {
        html += '<tr>';
        r.forEach(cell => {
          html += `<td class="border px-3 py-2 text-center font-mono">${cell}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';

      resultEl.innerHTML = html;
    }

    btnValidasi.addEventListener('click', async () => {
      // Validasi input: hanya angka dan maksimal 7 digit
      const kepalaVal = inputKepala.value.trim();
      const ekorVal = inputEkor.value.trim();
      const validDigit = /^\d{0,7}$/;

      if (!validDigit.test(kepalaVal)) {
        alert('Input Kepala Main hanya boleh angka maksimal 7 digit tanpa spasi atau tanda.');
        return;
      }
      if (!validDigit.test(ekorVal)) {
        alert('Input Ekor Main hanya boleh angka maksimal 7 digit tanpa spasi atau tanda.');
        return;
      }

      loadingEl.classList.remove('hidden');
      resultEl.innerHTML = '';

      try {
        const data = await fetchSheet();
        const { rows, headers } = filterData(data, kepalaVal, ekorVal);
        renderTable(headers, rows);
      } catch (err) {
        console.error(err);
      } finally {
        loadingEl.classList.add('hidden');
      }
    });
  </script>

</body>
</html>
