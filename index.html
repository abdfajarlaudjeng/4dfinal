<!doctype html>
<html lang="id" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Validasi Data 4D dan Tampilkan Data</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex min-h-screen bg-gray-100 font-sans">

  <!-- Navbar kiri -->
  <nav class="w-56 bg-white shadow-md p-6 flex flex-col">
    <h2 class="text-xl font-bold mb-6 border-b pb-2">Menu Navigasi</h2>
    <a href="#" class="mb-3 text-gray-700 hover:text-blue-600">Dashboard</a>
    <a href="#" class="mb-3 text-gray-700 hover:text-blue-600">Validasi 4D</a>
    <a href="#" class="mb-3 text-gray-700 hover:text-blue-600">Data Lainnya</a>
  </nav>

  <!-- Konten utama -->
  <main class="flex-1 p-6 max-w-4xl mx-auto">

    <h1 class="text-2xl font-bold mb-6 text-center">Data 4D (Kolom B2-B13) dan Validasi</h1>

    <div class="bg-white p-6 rounded-lg shadow mb-6 grid gap-6">
      <div>
        <label for="inputKepala" class="block font-medium mb-1">Input Kepala Main (max 7 digit tanpa spasi atau tanda lain)</label>
        <input type="text" id="inputKepala" maxlength="7" placeholder="Contoh: 1234567" class="w-full border rounded px-3 py-2" pattern="\d*" title="Hanya angka" />
      </div>
      <div>
        <label for="inputEkor" class="block font-medium mb-1">Input Ekor Main (max 7 digit tanpa spasi atau tanda lain)</label>
        <input type="text" id="inputEkor" maxlength="7" placeholder="Contoh: 7654321" class="w-full border rounded px-3 py-2" pattern="\d*" title="Hanya angka" />
      </div>
      <div>
        <label for="inputAngkaMain" class="block font-medium mb-1">Input Angka Main (max 10 baris, 7 digit per baris)</label>
        <textarea id="inputAngkaMain" rows="10" maxlength="70" placeholder="Masukkan angka main, satu per baris, max 7 digit" class="w-full border rounded px-3 py-2 font-mono"></textarea>
      </div>
      <div>
        <label for="inputShio" class="block font-medium mb-1">Input Shio (pisahkan dengan koma, misal: 1,3,7)</label>
        <input type="text" id="inputShio" placeholder="Misal: 1,3,7" class="w-full border rounded px-3 py-2" />
      </div>
      <button id="btnValidasi" class="bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition-colors">Validasi</button>
    </div>

    <div id="loading" class="hidden text-blue-600 mb-4 text-center font-semibold">‚è≥ Memproses data...</div>

    <div id="result" class="overflow-x-auto bg-white p-4 rounded-lg shadow font-mono max-h-[400px] overflow-y-auto">
      <!-- Tabel akan muncul di sini -->
    </div>

  </main>

<script>
  const SHEET_ID = '1jQWs8CTzPzibBDQ-btIexLE70oMqdhIFZOrnZ8dbEUQ';
  const SHEET_NAME = '4d';
  const gvizUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&headers=1`;

  const shioMap = {
    1: ["01","13","25","37","49","61","73","85","97"],
    2: ["02","14","26","38","50","62","74","86","98"],
    3: ["03","15","27","39","51","63","75","87","99"],
    4: ["04","16","28","40","52","64","76","88","00"],
    5: ["05","17","29","41","53","65","77","89"],
    6: ["06","18","30","42","54","66","78","90"],
    7: ["07","19","31","43","55","67","79","91"],
    8: ["08","20","32","44","56","68","80","92"],
    9: ["09","21","33","45","57","69","81","93"],
    10: ["10","22","34","46","58","70","82","94"],
    11: ["11","23","35","47","59","71","83","95"],
    12: ["12","24","36","48","60","72","84","96"]
  };

  const inputKepala = document.getElementById('inputKepala');
  const inputEkor = document.getElementById('inputEkor');
  const inputAngkaMain = document.getElementById('inputAngkaMain');
  const inputShio = document.getElementById('inputShio');
  const btnValidasi = document.getElementById('btnValidasi');
  const loadingEl = document.getElementById('loading');
  const resultEl = document.getElementById('result');

  let allData = [];

  async function fetchSheet() {
    const res = await fetch(gvizUrl);
    const text = await res.text();
    const jsonText = text.replace(/^.*setResponse\(|\);\s*$/gs, '');
    const data = JSON.parse(jsonText).table;

    // Ambil baris 2 sampai 13 (index 1 sampai 12)
    // Ambil kolom B (index 1)
    const rows = data.rows.slice(1,13).map(r => {
      const cell = r.c[1];
      return cell && cell.v !== null ? String(cell.v) : "";
    });
    return rows;
  }

  // Render tabel data 4D yang diberikan
  function renderTable(data) {
    if (!data.length) {
      resultEl.innerHTML = "<p class='text-center text-red-600'>Tidak ada data yang cocok.</p>";
      return;
    }

    let html = `<table class="table-auto w-full border border-gray-300 text-center">
      <thead>
        <tr class="bg-gray-200">
          <th class="border border-gray-300 px-3 py-1">No</th>
          <th class="border border-gray-300 px-3 py-1">Angka 4D</th>
          <th class="border border-gray-300 px-3 py-1">Kepala (Digit ke-3)</th>
          <th class="border border-gray-300 px-3 py-1">Ekor (Digit ke-4)</th>
          <th class="border border-gray-300 px-3 py-1">2 Digit Terakhir (Shio)</th>
        </tr>
      </thead><tbody>`;

    data.forEach((num, i) => {
      const kepala = num.length >=4 ? num[2] : "-";
      const ekor = num.length >=4 ? num[3] : "-";
      const duaDigit = num.length >=2 ? num.slice(-2) : "-";

      html += `<tr>
        <td class="border border-gray-300 px-3 py-1">${i+1}</td>
        <td class="border border-gray-300 px-3 py-1 font-bold">${num}</td>
        <td class="border border-gray-300 px-3 py-1">${kepala}</td>
        <td class="border border-gray-300 px-3 py-1">${ekor}</td>
        <td class="border border-gray-300 px-3 py-1">${duaDigit}</td>
      </tr>`;
    });

    html += `</tbody></table>`;
    resultEl.innerHTML = html;
  }

  function filterData(data, kepalaInput, ekorInput, angkaMainList, shioSelected) {
    if (!kepalaInput.length && !ekorInput.length && angkaMainList.length === 0 && shioSelected.length === 0) {
      return data; // semua data tanpa filter
    }

    return data.filter(num => {
      if (!num || num.length < 4) return false;

      const kepala = num[2];
      const ekor = num[3];
      const duaDigit = num.slice(-2);

      // Filter kepala
      if (kepalaInput.length > 0 && !kepalaInput.includes(kepala)) return false;

      // Filter ekor
      if (ekorInput.length > 0 && !ekorInput.includes(ekor)) return false;

      // Filter angka main (cocokkan digit kepala atau ekor ada di angka main)
      if (angkaMainList.length > 0) {
        const matchMain = angkaMainList.some(am => am.includes(kepala) || am.includes(ekor));
        if (!matchMain) return false;
      }

      // Filter shio
      if (shioSelected.length > 0) {
        const matchShio = shioSelected.some(sh => shioMap[sh]?.includes(duaDigit));
        if (!matchShio) return false;
      }

      return true;
    });
  }

  btnValidasi.addEventListener('click', () => {
    loadingEl.classList.remove('hidden');
    setTimeout(() => {
      // Ambil nilai input dan validasi
      const kepalaVal = inputKepala.value.trim();
      const ekorVal = inputEkor.value.trim();
      const angkaMainRaw = inputAngkaMain.value.trim();
      const shioRaw = inputShio.value.trim();

      // Validasi input angka kepala dan ekor (maks 7 digit, angka saja)
      const validDigit = /^\d{0,7}$/;
      if (!validDigit.test(kepalaVal)) {
        alert('Input Kepala hanya boleh angka maksimal 7 digit tanpa spasi atau tanda.');
        loadingEl.classList.add('hidden');
        return;
      }
      if (!validDigit.test(ekorVal)) {
        alert('Input Ekor hanya boleh angka maksimal 7 digit tanpa spasi atau tanda.');
        loadingEl.classList.add('hidden');
        return;
      }

      // Proses angka main (max 10 baris, max 7 digit per baris)
      let angkaMainList = angkaMainRaw
        .split('\n')
        .map(l => l.trim())
        .filter(l => l.length > 0)
        .slice(0,10);
      for (const am of angkaMainList) {
        if (!/^\d{1,7}$/.test(am)) {
          alert('Setiap baris Angka Main harus berupa angka tanpa spasi/tanda, maksimal 7 digit.');
          loadingEl.classList.add('hidden');
          return;
        }
      }

      // Proses shio input
      let shioSelected = shioRaw.split(',')
        .map(s => s.trim())
        .filter(s => s && !isNaN(s) && s >= 1 && s <= 12);

      // Filter data dan render tabel
      const filtered = filterData(allData, kepalaVal.split(''), ekorVal.split(''), angkaMainList, shioSelected);
      renderTable(filtered);
      loadingEl.classList.add('hidden');
    }, 300);
  });

  // Ambil data saat load halaman
  window.onload = async () => {
    loadingEl.classList.remove('hidden');
    try {
      allData = await fetchSheet();
      renderTable(allData);
    } catch (e) {
      resultEl.innerHTML = `<p class="text-center text-red-600">Gagal memuat data: ${e.message}</p>`;
    }
    loadingEl.classList.add('hidden');
  };
</script>

</body>
</html>
