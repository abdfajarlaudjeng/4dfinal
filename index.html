<!doctype html>
<html lang="id" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Validasi Data 4D dengan Navbar & Angka Main</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex min-h-screen bg-gray-100 font-sans">

  <!-- Navbar kiri -->
  <nav class="w-56 bg-white shadow-md p-6 flex flex-col">
    <h2 class="text-xl font-bold mb-6 border-b pb-2">Menu Navigasi</h2>
    <a href="#" class="mb-3 text-gray-700 hover:text-blue-600">Dashboard</a>
    <a href="#" class="mb-3 text-gray-700 hover:text-blue-600">Validasi 4D</a>
    <a href="#" class="mb-3 text-gray-700 hover:text-blue-600">Data Lainnya</a>
  </nav>

  <!-- Konten utama -->
  <main class="flex-1 p-6 max-w-5xl mx-auto">

    <h1 class="text-2xl font-bold mb-6 text-center">Validasi Data 4D (Sheet 4d)</h1>

    <div class="bg-white p-6 rounded-lg shadow mb-6 grid gap-6">
      <div>
        <label for="inputKepala" class="block font-medium mb-1">Input Kepala Main (max 7 digit tanpa spasi atau tanda lain)</label>
        <input type="text" id="inputKepala" maxlength="7" placeholder="Contoh: 1234567" class="w-full border rounded px-3 py-2" pattern="\d*" title="Hanya angka" />
      </div>
      <div>
        <label for="inputEkor" class="block font-medium mb-1">Input Ekor Main (max 7 digit tanpa spasi atau tanda lain)</label>
        <input type="text" id="inputEkor" maxlength="7" placeholder="Contoh: 7654321" class="w-full border rounded px-3 py-2" pattern="\d*" title="Hanya angka" />
      </div>
      <div>
        <label for="inputAngkaMain" class="block font-medium mb-1">Input Angka Main (max 10 baris, 7 digit per baris)</label>
        <textarea id="inputAngkaMain" rows="10" maxlength="70" placeholder="Masukkan angka main, satu per baris, max 7 digit" class="w-full border rounded px-3 py-2 font-mono"></textarea>
      </div>
      <button id="btnValidasi" class="bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition-colors">Validasi</button>
    </div>

    <div id="loading" class="hidden text-blue-600 mb-4 text-center font-semibold">‚è≥ Memproses data...</div>

    <div id="result" class="overflow-x-auto bg-white p-4 rounded-lg shadow"></div>

  </main>

<script>
  const SHEET_ID = '1jQWs8CTzPzibBDQ-btIexLE70oMqdhIFZOrnZ8dbEUQ';
  const SHEET_NAME = '4d';
  const gvizUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&headers=1`;

  const inputKepala = document.getElementById('inputKepala');
  const inputEkor = document.getElementById('inputEkor');
  const inputAngkaMain = document.getElementById('inputAngkaMain');
  const btnValidasi = document.getElementById('btnValidasi');
  const loadingEl = document.getElementById('loading');
  const resultEl = document.getElementById('result');

  async function fetchSheet() {
    const res = await fetch(gvizUrl);
    const text = await res.text();
    const jsonText = text.replace(/^.*setResponse\(|\);\s*$/gs, '');
    return JSON.parse(jsonText).table;
  }

  function filterData(table, kepalaInput, ekorInput, angkaMainList) {
    const rows = table.rows.map(r => r.c.map(c => c && c.v !== null ? String(c.v) : ""));
    const headers = table.cols.map(c => c.label || '');

    // Jika semua input kosong, tampilkan semua
    if (!kepalaInput && !ekorInput && angkaMainList.length === 0) return { rows, headers };

    return {
      rows: rows.filter(r => {
        const num = r[0];
        if (!num || num.length < 4) return false;

        const kepala = num[2]; // digit ke-3
        const ekor = num[3];   // digit ke-4

        let passKepala = true;
        let passEkor = true;
        let passMain = true;

        if (kepalaInput.length > 0) passKepala = kepalaInput.includes(kepala);
        if (ekorInput.length > 0) passEkor = ekorInput.includes(ekor);

        if (angkaMainList.length > 0) {
          // Cek angka main: angka main cocok jika angka kepala atau ekor muncul dalam salah satu baris angka main
          passMain = angkaMainList.some(am => {
            return am.includes(kepala) || am.includes(ekor);
          });
        }

        return passKepala && passEkor && passMain;
      }),
      headers
    };
  }

  function renderTable(headers, rows) {
    if (!rows.length) {
      resultEl.innerHTML = '<p class="text-center text-gray-600 font-semibold">Tidak ada data cocok.</p>';
      return;
    }

    let html = '<table class="table-auto border-collapse w-full">';
    html += '<thead><tr>';
    headers.forEach(h => {
      html += `<th class="border px-3 py-2 bg-gray-100 text-center">${h}</th>`;
    });
    html += '</tr></thead><tbody>';

    rows.forEach(r => {
      html += '<tr>';
      r.forEach(cell => {
        html += `<td class="border px-3 py-2 text-center font-mono">${cell}</td>`;
      });
      html += '</tr>';
    });

    html += '</tbody></table>';

    resultEl.innerHTML = html;
  }

  btnValidasi.addEventListener('click', async () => {
    const kepalaValRaw = inputKepala.value.trim();
    const ekorValRaw = inputEkor.value.trim();
    const angkaMainRaw = inputAngkaMain.value.trim();

    // Validasi angka input: hanya digit, max 7 digit per input kepala dan ekor
    const validDigit = /^\d{0,7}$/;
    if (!validDigit.test(kepalaValRaw)) {
      alert('Input Kepala Main hanya boleh angka maksimal 7 digit tanpa spasi atau tanda.');
      return;
    }
    if (!validDigit.test(ekorValRaw)) {
      alert('Input Ekor Main hanya boleh angka maksimal 7 digit tanpa spasi atau tanda.');
      return;
    }

    // Proses angka main (max 10 baris, 7 digit per baris)
    let angkaMainList = angkaMainRaw
      .split('\n')
      .map(l => l.trim())
      .filter(l => l.length > 0)
      .slice(0, 10);
    // Validasi tiap baris angka main
    for (const am of angkaMainList) {
      if (!/^\d{1,7}$/.test(am)) {
        alert('Setiap baris Angka Main harus berupa angka tanpa spasi/tanda, maksimal 7 digit.');
        return;
      }
    }

    loadingEl.classList.remove('hidden');
    resultEl.innerHTML = '';

    try {
      const data = await fetchSheet();
      const { rows, headers } = filterData(data, kepalaValRaw.split(''), ekorValRaw.split(''), angkaMainList);
      renderTable(headers, rows);
    } catch (err) {
      resultEl.innerHTML = `<p class="text-red-600 text-center font-semibold">Gagal memuat data: ${err.message}</p>`;
    } finally {
      loadingEl.classList.add('hidden');
    }
  });
</script>

</body>
</html>
